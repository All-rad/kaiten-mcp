# Feature Specification: Тестовая интеграция с Kaiten API

**Feature Branch**: `001-kaiten-auth`  
**Created**: 2026-02-01  
**Status**: Draft  
**Input**: User description: "Тестовая интеграция с Kaiten API — пользователь вводит URL своей организации и личный токен Kaiten; приложение проверяет токен, получает данные текущего пользователя и сохраняет их для дальнейшего использования."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Подключение и проверка токена (Priority: P1)

Пользователь вводит URL организации и свой личный токен Kaiten, нажимает «Проверить/Подключиться». Система выполняет запрос к Kaiten API для получения текущего пользователя и отображает имя/идентификатор пользователя при успешной авторизации.

**Why this priority**: Это основной путь — без успешной авторизации интеграция бесполезна.

**Independent Test**: Ввести валидный URL и токен, нажать «Проверить», увидеть профиль пользователя в UI.

**Acceptance Scenarios**:

1. **Given** пользователь не подключён, **When** вводит корректный URL и токен и нажимает «Проверить», **Then** система показывает имя пользователя и сохраняет токен и профиль.
2. **Given** пользователь вводит неверный токен, **When** нажимает «Проверить», **Then** показывается понятная ошибка (например, «Неверный токен или доступ запрещён»).

---

### User Story 2 - Сохранение и автозагрузка (Priority: P2)

После успешной проверки токен и профиль должны сохраняться локально (в открытом виде, как указано в требованиях) и автоматически загружаться при следующем запуске приложения, при этом профиль обновляется повторным запросом к Kaiten при старте.

**Why this priority**: Удобство пользователя и требование сохранять данные между запусками.

**Independent Test**: Успешно подключиться, перезапустить приложение, убедиться что профиль загружен автоматически и отображается в UI.

**Acceptance Scenarios**:

1. **Given** подключение было успешно, **When** приложение запускается снова, **Then** профиль пользователя отображается без повторного ввода токена.
2. **Given** подключение было успешно, **When** приложение запускается снова, **Then** приложение выполняет проверку (рефреш) профиля и обновляет его при изменениях.

---

### User Story 3 - Сброс авторизации (Priority: P2)

В интерфейсе есть кнопка «Сброс авторизации», которая затирает сохранённый токен и профиль, возвращая интерфейс в состояние «не подключён».

**Why this priority**: Позволяет пользователю быстро удалить учётные данные и сменить учётную запись.

**Independent Test**: Нажать «Сброс авторизации», убедиться, что токен и профиль удалены и UI показывает состояние «не подключён».

**Acceptance Scenarios**:

1. **Given** пользователь подключён, **When** нажимает «Сброс авторизации», **Then** токен и профиль удаляются и UI показывает поле ввода для повторной авторизации.

---

### Edge Cases

- Неверный или недоступный URL организации (таймаут, DNS ошибка).
- Токен истёк или не имеет прав для получения данных пользователя (401/403).
- Ответ API не содержит ожидаемых полей — обработка и вывод понятного сообщения.
- Ограничения частоты запросов (rate limiting) — показать подходящее сообщение и предложить повторить позже.

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Интерфейс должен предоставлять поля для ввода URL организации и личного токена, кнопки «Проверить/Подключиться» и «Сброс авторизации».
- **FR-002**: При нажатии «Проверить/Подключиться» система должна выполнить запрос к Kaiten API для получения текущего профиля пользователя (см. https://developers.kaiten.ru/users/retrieve-current-user) и отобразить основные данные (имя, email/идентификатор).
- **FR-003**: При успешной проверке токен и профиль должны сохраняться локально в открытом виде и оставаться доступными между запусками приложения.
- **FR-004**: При каждом запуске приложения приложение должно автоматически загружать сохранённые данные и выполнять проверку/обновление профиля пользователя.
- **FR-005**: Кнопка «Сброс авторизации» должна удалять токен и профиль из локального хранилища и обновлять UI в состояние «не подключён».
- **FR-006**: При ошибках сети или при невалидном токене система должна показывать понятные и локализованные сообщения об ошибке и не сохранять неверные учётные данные.
- **FR-007**: При выборе методов для запроса использовать, по возможности, методы из последней версии Kaiten API и ссылаться на официальную документацию.

### Key Entities *(include if feature involves data)*

- **KaitenCredentials**: { orgUrl, token, savedAt }
- **KaitenUserProfile**: { id, name, email, rawResponse }

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% пользователей с валидными учётными данными, вводящими корректный URL и токен, получают отображаемый профиль после проверки (функциональное тестирование).
- **SC-002**: Профиль и токен сохраняются и автоматически загружаются при старте приложения в 100% проверяемых случаев (повторяемый интеграционный тест).
- **SC-003**: Кнопка «Сброс авторизации» удаляет все сохранённые данные незамедлительно (проверяется вручную и автоматизированно).
- **SC-004**: При введении неверного токена пользователь получает читабельное сообщение об ошибке (100% тестов на недействительные токены проходят).
- **SC-005**: Проверка токена и получение профиля выполняются в приемлемое время (например, менее 10 секунд в нормальных сетевых условиях).

## Additional Requirements

- **FR-008**: Данные (orgUrl, token, профиль) должны сохраняться в локальной SQLite базе данных в открытом виде. При старте приложения необходимо проверять наличие БД и при отсутствии — создавать её и необходимые таблицы (миграция).

## Assumptions

- Под «сохранением в открытом виде» понимается хранение данных без дополнительного шифрования на уровне приложения, в локальной SQLite базе данных (например, `data/kaiten.db`). Это решение принято по запросу заинтересованной стороны и подразумевает известные риски безопасности.
- Приложение должно уметь автоматически создать или инициализировать таблицу `kaiten_credentials` со столбцами `{ id INTEGER PRIMARY KEY, org_url TEXT, token TEXT, profile_json TEXT, saved_at TEXT }` при первом запуске.

## Open Questions / Resolved

- **Q1 (Сохранение и безопасность) — RESOLVED**: Выбран вариант хранения в открытом виде в локальной SQLite БД.  
  **Detail**: Хранение в `kaiten_credentials` (см. выше). При необходимости позже можно добавить опциональное шифрование или переход на защищённое хранилище.

---

